<p></p><p>【教学资源类别】</p><table border="1" cellspacing="0" style="width:100.0%">	<tbody>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>序号</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>类别</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>打勾&radic;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>1</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>学习资源</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&radic;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>2</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>单兵模式赛题资源</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&nbsp;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>3</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>分组对抗赛题资源</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&nbsp;</p>			</td>		</tr>	</tbody></table><p>&nbsp;【教学资源名称】&nbsp;</p><p>&nbsp; VPN安全-通过Windows2003网络服务搭建IPSec协议分析</p><p>&nbsp;【教学资源分类】</p><table border="1" cellspacing="0" style="width:100.0%">	<tbody>		<tr>			<td style="height:14.0pt; width:25.1%">			<p>一级大类</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>二级大类</p>			</td>			<td style="height:14.0pt; width:19.12%">			<p>打勾&radic;</p>			</td>		</tr>		<tr>			<td rowspan="5" style="height:14.0pt; width:25.1%">			<p>1.安全标准</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>法律法规</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>行业标准</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>安全意识</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>应急响应</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>安全评估</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td rowspan="2" style="height:14.0pt; width:25.1%">			<p>2.系统安全</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>Windows操作系统安全配置</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>Linux操作系统安全配置</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td rowspan="2" style="height:14.0pt; width:25.1%">			<p>3.网络安全</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>网络设备安全</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>网络协议分析</p>			</td>			<td style="height:14.0pt; width:19.12%">			<p>&radic;</p>			</td>		</tr>		<tr>			<td rowspan="7" style="height:14.0pt; width:25.1%">			<p>4.应用安全</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>Web应用安全</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>数据库安全</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>中间件应用安全</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>应用层协议分析</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>移动应用安全</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>VPN应用</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>恶意代码分析</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td rowspan="2" style="height:14.0pt; width:25.1%">			<p>5.密码学</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>密码学原理</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>密码学应用</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td rowspan="3" style="height:14.0pt; width:25.1%">			<p>6.渗透测试</p>			</td>			<td style="height:14.0pt; width:55.78%">			<p>常用工具</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>脚本编写</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>		<tr>			<td style="height:14.0pt; width:55.78%">			<p>报告编写</p>			</td>			<td style="height:14.0pt; width:19.12%">&nbsp;</td>		</tr>	</tbody></table><p>【难度说明】</p><table border="1" cellspacing="0" style="width:100.0%">	<tbody>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>序号</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>难度等级</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>打勾&radic;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>1</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>简单</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&radic;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>2</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>一般</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&nbsp;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>3</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>困难</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&nbsp;</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:33.32%">			<p>4</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>极难</p>			</td>			<td style="vertical-align:top; width:33.34%">			<p>&nbsp;</p>			</td>		</tr>	</tbody></table><p>【背景描述】</p><p>XX企业，为加强信息化建设，组建了企业内部网络，用于自身网站的建设，小王是该企业新进网管，承担网络的管理工作。</p><p>现该企业网络存在如下需求：</p><p>如果在企业网络中采用明文的方式传输数据，容易出现网络监听攻击，造成数据的泄露；针对此问题，需要提出针对此攻击的解决方案，在此之前，需要首先对IPSec的工作原理进行研究。</p><p>&nbsp;【实训设备】</p><table border="1" cellspacing="0">	<tbody>		<tr>			<td style="vertical-align:top; width:4.0cm">			<p>产品型号</p>			</td>			<td style="vertical-align:top; width:199.5pt">			<p>产品描述</p>			</td>			<td style="vertical-align:top; width:69.8pt">			<p>数量</p>			</td>		</tr>		<tr>			<td style="vertical-align:top; width:4.0cm">			<p>PY-P8</p>			</td>			<td style="vertical-align:top; width:199.5pt">			<p>实训室安全、应用环境实训平台</p>			</td>			<td style="vertical-align:top; width:69.8pt">			<p>1</p>			</td>		</tr>	</tbody></table><p>【预备知识】</p><p>&nbsp;&nbsp;&nbsp; IPSec是一个标准的加密技术，通过插入一个预定义头部的方式来保障OSI上层协议数据的安全。IPSec提供了网络层的安全性。</p><p>&nbsp;</p><p>&nbsp;</p><p>IPSec相对于GRE技术，提供了更多的安全特性，对VPN流量提供了如下三个方面的保护：</p><p>私密性（Confidentiality）：数据私密性也就是对数据进行加密，就算第三方能够捕获加密后的数据，也不能恢复成明文。</p><p>完整性（Integrity）：完整性确保数据在传输过程中没有被第三方篡改。</p><p>源验证（Authentication）：源认证也就是对发送数据包的源进行认证，确保是合法的源发送了此数据包。</p><p>&nbsp;</p><p>&nbsp;</p><p>（图示：IPSec框架）</p><p>&nbsp;</p><p>传统的一些安全技术例如：HTTPS和一些老的无线安全技术（WEP/WPA），它们都是固定使用某一特定加密和散列函数。这种做法有点赌博性质，因为如果某一天这个安全算法曝出严重漏洞，那么使用这个加密算法或者散列函数的安全技术也就不应该再被使用了。为了防止这种在一棵树上吊死的悲惨事件发生。IPSec并没有定义具体的加密和散列函数，而是提供了一个框架。每一次IPSec会话所使用的具体算法，可以协商决定，也就是说如果我们觉得3DES这个算法所提供的168位的加密强度能够满足当前的需要，那么暂时就可以用这个协议来加密数据，如果某一天3DES出现了严重漏洞，或者出现了一个更好的加密协议，我们可以马上修改加密协议。让我们的IPSec VPN总是使用最新最好的协议。下面就是IPSec框架示意图，这个图说明，不仅仅是散列函数，加密算法，还有封装协议和模式，密钥有效期等等内容都可以协商决定。</p><p>&nbsp;</p><p>接下来介绍IPSec的两种封装协议：</p><p>1. ESP</p><p>2. AH</p><p>ESP（Encapsulation Security Payload）协议</p><p>ESP的IP协议号为50，ESP能够对数据提供私密性（加密）完整性和源认证。并且能够抵御重放攻击（反复发送相同的包，接收方由于不断的解密消耗系统资源，实现拒绝服务攻击（DOS））ESP只保护IP负载数据，不对原始IP头部进行任何安全防护下面是ESP的包结构。</p><p>&nbsp;</p><p>&nbsp;</p><p>（图示：ESP头部示意图）</p><p>&nbsp;</p><p>安全参数索引（SPI）：</p><p>一个32位的字段，用来标识处理数据包的安全关联（Security Association）。</p><p>序列号（SN）</p><p>一个单调增长的序号，用来标识一个ESP数据包。例如：当前发送的ESP包序列号是101，下一个传输的ESP包序列号就是102，再下一个就是103。接收方通过序列号来防止重放攻击，原理也很简单，当接收方收到序列号102的ESP包后，如果再次收到102的ESP包就被视为重放攻击，采取丢弃处理。</p><p>初始化向量（Initialization Vector）</p><p>CBC块加密为每一个包产生的随机数，用来扰乱加密后的数据。当然IPSec VPN也可以选择不加密（加密不是必须的，虽然我们一般都采用），如果不加密就不存在IV字段。</p><p>负载数据（Payload Data）</p><p>负载数据就是IPSec实际加密的内容，很有可能就是TCP头部加相应的应用层数据，当然我们后面还会介绍两种封装模式，封装模式不同也会影响负载数据的内容。</p><p>垫片（Padding）</p><p>IPSec VPN都采用CBC的块加密方式，既然采用块加密，就需要把数据补齐块边界，以DES为例，就需要补齐64位的块边界，追加的补齐块边界的数据就叫做垫片。如果不加密就不存在垫片字段。</p><p>垫片长度（Pad Length）</p><p>垫片长度顾名思义就是告诉接收方，垫片数据有多长，接收方解密后就可以清除这部分多余数据。如果不加密就不存在垫片长度字段。</p><p>下一个头部（Next Header）</p><p>下一个头部标识IPSec封装负载数据里边的下一个头部，根据封装模式的不同下一个头部也会发生变化，如果是传输模式，下一个头部一般都是传输层头部（TCP/UDP），如果是隧道模式，下一个头部肯定是IP。关于传输和隧道模式我们会在本章后面部分进行介绍。我们也能从&ldquo;下个头部&rdquo;这个字段看到IPv6的影子，IPv6的头部就是使用很多个&ldquo;下一个头部&rdquo;串接在一起的，这也说明IPSec最初是为IPv6设计的。</p><p>认证数据（Authentication Data）</p><p>ESP会对从ESP头部到ESP尾部的所有数据进行验证，也就是做HMAC的散列计算，得到的散列值就会被放到认证数据部分，接收方可以通过这个认证数据部分对ESP数据包进行完整性和源认证的校验。</p><p>AH（Authentication Header）协议</p><p>AH的IP协议号为51，AH只能够对数据提供完整性和源认证，并且抵御重放攻击。AH并不对数据提供私密性服务，也就是说不加密，所以在实际部署IPSec VPN的时候很少使用AH，绝大部分都使用ESP来封装。当然AH不提供私密性服务，只是其中一个原因，后面部分我们还会介绍AH不被大量使用的另外一个原因。我们先通过下图来看看AH的包结构：</p><p>&nbsp;</p><p>&nbsp;</p><p>（图示：AH头部示意图）</p><p>&nbsp;</p><p>AH翻译成中文就叫做认证头部，得名的原因就是它和ESP不一样，ESP不验证原始IP头部，AH却要对IP头部的一些，它认为不变的字段进行验证。我们可以通过下图来看看哪些字段AH认为是不变的。</p><p>&nbsp;</p><p>&nbsp;</p><p>（图示：AH验证IP头部字段介绍）</p><p>&nbsp;</p><p>这个图中的灰色部分是不进行验证的（散列计算），但是白色部分AH认为应该不会发生变化，需要对这些部分进行验证。可以看到IP地址字段是需要验证的，不能被修改。AH这么选择也有它自身的原因。IPSec的AH封装最初是为IPv6设计的，在IPv6的网络里地址不改变非常正常，但是我们现在使用的主要是IPv4的网络，地址转换技术（NAT）经常被采用。一旦AH封装的数据包穿越NAT，地址就会改变，抵达目的地之后就不能通过验证，所以AH协议封装的数据是不能穿越NAT，这就是AH不被IPSec大量使用的第二个原因。</p><p>&nbsp;</p><p>&nbsp;</p><p>【实验步骤】</p><p>网络拓扑：BackTrack5--Windows2003--Windows2003</p><p>bt5&nbsp;<br />用户：root<br />密码：toor</p><p>windows server 2003<br />用户：administrator<br />密码：空</p><p>第一步：为服务器和客户机分别配置IP地址，并测试连通性</p><p>第二步：分别在服务器和客户机控制台中添加IP安全管理单元</p><p>第三步：分别在服务器和客户机创建IP安全策略</p><p>第四步：分别在服务器和客户机添加IP安全规则</p><p>第五步：分别在服务器和客户机指派IP安全策略</p><p>第六步：验证服务器和客户机之间基于IP安全策略的连通性</p><p>第七步：打开WireShark，并配置过滤条件</p><p>&nbsp;</p><p>第八步：再次验证服务器和客户机之间基于IP安全策略的连通性</p><p>第九步：打开WireShark，对照预备知识，对ESP数据对象进行分析</p><p>&nbsp;</p><p>&nbsp;</p><p>实验结束，关闭虚拟机。</p>