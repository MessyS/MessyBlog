(function () {
	'use strtic';

	var listAllNums = 0
    var moreData = 1

	function photosAjax(n,asyncY){
        $.ajax({
            url: '/photosAjax/',
            type: 'POST',
            headers:{
                "X-CSRFToken":$.cookie('csrftoken')
            },
            async:asyncY,
            data:{
                'n':n,
            },
            success: function (data) {
                if(moreData == 1){
                    for(let i=0;i<data['listData'].length;i++){
                        listAllNums += 1
                        let img = new Image()
                        img.src = data['listData'][i].imgS
                        img.onload = function(){
                            var imgWidth = img.width
                            var imgHeight = img.height

                            var imgTag = document.createElement("div")
                            if(imgWidth > imgHeight){
                                imgTag.className = 'g-body-photos-black g-body-photos-black-sma'
                            }else{
                                let randomNum = Math.random() * 10
                                if(randomNum <= 4){
                                    imgTag.className = 'g-body-photos-black g-body-photos-black-big'
                                }else{
                                    imgTag.className = 'g-body-photos-black g-body-photos-black-med'
                                }
                            }
                            imgTag.style.background = 'url(' + data['listData'][i].imgS + ')'
                            $('.g-body-photos').append(imgTag)
                        }
                    }
                }else{
                    $('.g-body-photos-meg').html('<p style="color:#AAA">没有更多数据了哦~~~</p>')
                }
                if(listAllNums < data['listAllNums']){
                    moreData = 0;
                }
            },
            error:function(){
                $('.g-body-photos-meg').html('<p style="color:red">数据请求失败，请重试...</p>')
            }
        });
    }

    // 初始加载30张
    photosAjax(30,true)

    window.onload = function(){
        // 判断触底
        function isBottom(){
            let viewHeight = $(document).height();
            let winHeight = $(window).height()
            let nowHeight = $(window).scrollTop()

            if(viewHeight - winHeight == nowHeight){
                photosAjax(10,false)
            }
        }

        $(window).scroll(function () {isBottom()})
        $(window).resize(function () {isBottom()})
    }
}());