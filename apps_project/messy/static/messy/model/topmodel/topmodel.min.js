/*
 * @Author: Messy
 * @AuthorEmail: messygao@qq.com
 * @AuthorSite: https://www.messys.top
 * @Date: 2019-04-09 10:53:28
 * @LastEditTime: 2019-04-16 19:45:28
 */
(function(){
	'use strtic';

	// 鼠标事件
	function mouseFun() {
		// 手机菜单栏的展示
		$('.g-left-options').click(function(){
			$(".g-left-options div").toggleClass('g-left-options-black')	// 菜单打开动画
			$(".g-left-options-1").toggleClass('g-left-options-1-rotate')
			$(".g-left-options-2").toggleClass('g-left-options-2-none')
			$(".g-left-options-3").toggleClass('g-left-options-3-rotate')
			$(".g-top-navigation").toggleClass('g-top-navigation-show')		// 导航栏弹出
		})
		$(".g-top-navigation").click(function(){
			event.stopPropagation();				// 阻止点击穿透
		})
	}

	// 回顶
	function goTop(){
		$('#j-goTop').click(function(){
			$('body,html').animate({
				scrollTop:0
			},300);
			return false;
		});
	};

	// 页面定位改变事件方法
	function resizeFun(){
		// 侧边菜单隐藏内容展示
		if($(window).width() < 1000){
			$('.g-head,.g-left-options').show()
		}else{
			$('.g-head,.g-left-options').hide()
		}

		// 回顶按钮是否显示
		var s = $(window).scrollTop()
		if(s < 100){
			$('#j-goTop').fadeOut(500)
		}else{
			$("#j-goTop").fadeIn(500)
		};
	}
	function slidingFun(){
		$(window).scroll(function(){resizeFun()})
		$(window).resize(function(){resizeFun()})
	};

	// 权限
	function oauth() {
		// 登录页展开
		$('#j-top-navigation-fun-oauth').click(function (e) {
			e.preventDefault();
			$('.g-oauth').addClass('g-oauth-show')
			$('.g-oauth').removeClass('g-oauth-hide')
		});
		// 登录提交
		$('#j-oauth-sub-logIn').on('click', function (e) {
			e.preventDefault();
			let $loginMeg = $('#j-oauth-sub-logIn-meg')
			$loginMeg.empty()
			let confirmAllNode = $('.g-oauth-signUp-list')
			for (var i = 0; i < confirmAllNode.length; i++) {
				let confirmNo = confirmAllNode[i].style.display == 'none'
				if (confirmNo) {
					$loginMeg.html('<p>请正确填写完所有的值!</p>')
					break;
				} else {
					$.ajax({
						type: "POST",
						url: "/login/",
						headers: {
							"X-CSRFToken": $.cookie('csrftoken')
						},
						data: {
							'user': $('#j-oauth-username-LogIn').val(),
							'pwd': md5($('#j-oauth-password-LogIn').val()),
						},
						success: function (data) {
							$loginMeg.empty();
							console.log(data)
							if (data == 'adminSuc') {
								$loginMeg.html(`<p style='color:#19b955'>登录成功!跳转中...</p>`);
								window.location.href = '/manager/'
							} else if (data == 'userSuc') {
								$loginMeg.html(`<p style='color:#19b955'>登录成功!但是目前还木有用户页哦，请耐心等待(*´・ｖ・)</p>`);
								setTimeout(function () {
                                    history.go(0)
                                },2000)
							} else {
								$loginMeg.html(`<p>用户名或密码错误!</p>`)
							}
						},
						error: function () {
							$loginMeg.empty();
							$loginMeg.html(`<p>网络错误！请稍后再试...</p>`)
						}
					});
					break;
				}
			}
		});
		// 登录页内容切换
		$('.g-oauth-right-headers-logIn').click(function (e) {
			e.preventDefault();
			$('.g-oauth-right-form-block-logIn').show()
			$('.g-oauth-right-form-block-signUp').hide()
			$('.g-oauth-right-form-block-reSet').hide()
		});
		$('.g-oauth-right-form-forget').click(function (e) {
			e.preventDefault();
			$('.g-oauth-right-form-block-logIn').hide()
			$('.g-oauth-right-form-block-signUp').hide()
			$('.g-oauth-right-form-block-reSet').show()
		});
		$('.g-oauth-right-headers-signUp').click(function (e) {
			e.preventDefault();
			$('.g-oauth-right-form-block-logIn').hide()
			$('.g-oauth-right-form-block-signUp').show()
			$('.g-oauth-right-form-block-reSet').hide()
		});
		// 重置提交
		$('#j-oauth-sub-reSet').on('click', function (e) {
			e.preventDefault();
			let confirmAllNode = $('.g-oauth-reSet-list')
			let $reSetMeg = $('#j-oauth-sub-reSet-meg');
			$reSetMeg.empty();		// 清空提示信息的地方
			for (var i = 0; i < confirmAllNode.length; i++) {
				let confirmNo = confirmAllNode[i].style.display == 'none'
				if (confirmNo) {
					$reSetMeg.html('<p>请正确填写完所有的值!</p>')
					break;
				} else {
					$.ajax({
						type: "POST",
						url: "/reset/",
						headers: {
							"X-CSRFToken": $.cookie('csrftoken')
						},
						data: {
							'email': $('#j-oauth-email-reSet').val(),
							'oldPwd': md5($('#j-oauth-oldPwd-reSet').val()),
							'newPwd': md5($('#j-oauth-password-confirm-reSet').val()),
						},
						success: function (data) {
							if (data == 'suc') {
								$('input').val('');		// 清空所有input
								$reSetMeg.html(`<p style='color:#19b955'>重置成功!快去登录吧</p>`)
								setTimeout(function () {
									$(".g-oauth-right-headers-logIn").trigger("click");
								}, 2000)
							} else if (data == 'err1') {
								$reSetMeg.html(`<p>请填写完所有的值</p>`)
							} else if (data == 'err2') {
								$reSetMeg.html(`<p>用户名或密码错误!</p>`)
							}
						},
						error: function () {
							$reSetMeg.empty();
							$reSetMeg.html(`<p>网络错误！请稍后再试...</p>`)
						}
					});
					break;
				}
			}
		});
		// 注册弹出提示
		$('.g-oauth-right-quickLogin').children().click(function (e) {
			e.preventDefault();
			alert('暂不支持第三方登录，敬请谅解')
		});
		// 注册提交
		$('#j-oauth-sub-SignUp').on('click', function (e) {
			e.preventDefault();

			let confirmAllNode = $('.g-oauth-signUp-list')
			let $signupMeg = $('#j-oauth-sub-SignUp-meg')
			$signupMeg.empty();		// 清空提示信息的地方
			for (var i = 0; i < confirmAllNode.length; i++) {
				let confirmNo = confirmAllNode[i].style.display == 'none'
				if (confirmNo) {
					$signupMeg.html('<p>请正确填写完所有的值!</p>')
					break;
				} else {
					$.ajax({
						type: "POST",
						url: "/signUp/",
						headers: {
							"X-CSRFToken": $.cookie('csrftoken')
						},
						data: {
							'email': $('#j-oauth-email-SignUp').val(),
							'pwd': md5($('#j-oauth-password-confirm-SignUp').val()),
						},
						success: function (data) {
							if (data == 'suc') {
								$('input').val('');		// 清空所有input
								$signupMeg.html(`<p style='color:#19b955'>注册成功!快去登录吧！`);
								setTimeout(function () {
									$(".g-oauth-right-headers-logIn").trigger("click");
								}, 2000)
							} else if (data == 'err1') {
								$signupMeg.html(`<p>请填写完所有的值</p>`)
							} else if (data == 'err2') {
								$signupMeg.html(`<p>抱歉！该邮箱已经注册过了,试试另外的邮箱吧！</p>`)
							}
						},
						error: function () {
							$signupMeg.html(`<p>网络错误！请稍后再试...</p>`)
						}
					});
					break;
				}
			}
		});
		// 登录页关闭
		$('.g-oauth-exit').click(function (e) {
			e.preventDefault();
			$(this).parent().addClass('g-oauth-hide')
			$(this).parent().removeClass('g-oauth-show')
		});
        // 身份识别
        $.ajax({
            type: "POST",
            headers:{
                "X-CSRFToken":$.cookie('csrftoken')
            },
            url: "/auth/",
            success: function (data) {
                let $oauthHtml =  $('#j-top-navigation-fun-oauth')
                if(data['status'] == '1' && data['yeah'] == '1'){
                    $oauthHtml.parent().after(`<li><a href="/logout/" style="text-decoration: none;color: white;">登出</a></li>`)
                    $oauthHtml.replaceWith(`<a href="/manager/" style="text-decoration: none;color: white;" target="_blank">管理后台</a>`)
                }else if(data['status'] == '1'  && data['yeah'] != '1'){
                    $oauthHtml.parent().after(`<li><a href="/logout/" style="text-decoration: none;color: white;">登出</a></li>`)
                    $oauthHtml.replaceWith(`<a href="javascript:alert('抱歉!暂时没有普通用户个人中心')" style="text-decoration: none;color: white;">个人中心</a>`)
                }
            }
        });
	}

	// 前端表单验证
	function formConfirmReSet(){
		// 初始密码强度验证
		$("#j-oauth-password-reSet").focus(function(){
			$("#j-oauth-password-reSet-yes").hide()
			$(this).next().hide()
		})
		$("#j-oauth-password-reSet").change(function(){
			let val = $(this).val().toString()
			var patrn = /^(?![0-9]+$)(?![a-zA-Z]+$)(?![~!@#$%^&*()-_=+]+$)[0-9A-Za-z]{8,}$/;
			if(patrn.test(val)){
				$("#j-oauth-password-reSet-yes").fadeIn(500)
			}else{
				$(this).next().html('规则:至少8个字符;包含英文字母和数字;允许110键键盘第一排的特殊字符')
				$(this).next().show()
			}
		})
		// 确认密码验证
		$("#j-oauth-password-reSet").focus(function(){
			$("#j-oauth-password-reSet-confirm-yes").hide()
			$(this).next().hide()
		})
		$("#j-oauth-password-confirm-reSet").change(function(){
			let val = $(this).val().toString()
			let confirmYes = val == $('#j-oauth-password-confirm-reSet').val()
			if(confirmYes){
				$("#j-oauth-password-confirm-reSet").fadeIn(500)
			}else{
				$(this).next().html('密码不一致!')
				$(this).next().show()
			}
		})
	}
	function formConfirmSignUp(){
		// 邮箱验证
		$("#j-oauth-email-SignUp").focus(function(){
			$("#j-oauth-email-SignUp-yes").hide()
			$(this).next().hide()
		})
		$("#j-oauth-email-SignUp").change(function(){
			let val = $(this).val().toString()
			let emailYes = val.indexOf('.') != -1 && val.indexOf('@') != -1
			if(emailYes){
				$("#j-oauth-email-SignUp-yes").fadeIn(500)
			}else{
				$(this).next().html('请输入正确的邮箱!')
				$(this).next().show()
			}
		})
		// 初始密码强度验证
		$("#j-oauth-password-SignUp").focus(function(){
			$("#j-oauth-password-SignUp-yes").hide()
			$(this).next().hide()
		})
		$("#j-oauth-password-SignUp").change(function(){
			let val = $(this).val().toString()
			var patrn = /^(?![0-9]+$)(?![a-zA-Z]+$)(?![~!@#$%^&*()-_=+]+$)[0-9A-Za-z]{8,}$/;
			if(patrn.test(val)){
				$("#j-oauth-password-SignUp-yes").fadeIn(500)
			}else{
				$(this).next().html('规则:至少8个字符;包含英文字母和数字;允许110键键盘第一排的特殊字符')
				$(this).next().show()
			}
		})
		// 确认面膜验证
		$("#j-oauth-password-confirm-SignUp").focus(function(){
			$("#j-oauth-password-confirm-SignUp-yes").hide()
			$(this).next().hide()
		})
		$("#j-oauth-password-confirm-SignUp").change(function(){
			let val = $(this).val().toString()
			let confirmYes = val == $('#j-oauth-password-SignUp').val()
			if(confirmYes){
				$("#j-oauth-password-confirm-SignUp-yes").fadeIn(500)
			}else{
				$(this).next().html('密码不一致!')
				$(this).next().show()
			}
		})
	}

	// 搜索
	function searchHistory(){
		// 搜索页展示
		$('#j-top-navigation-fun-search').click(function (e) {
			e.preventDefault();
			$('.g-search').addClass('g-search-show')
			$('.g-search').removeClass('g-search-hide')
		});
		// 搜索页关闭
		$('.g-search-exit').click(function (e) {
			e.preventDefault();
			$(this).parent().addClass('g-search-hide')
			$(this).parent().removeClass('g-search-show')
		});

		// 热词展示
		$.ajax({
			type: "POST",
			url: "/siteSearchHot/",
			headers: {
			"X-CSRFToken": $.cookie('csrftoken')
			},
			success: function (data) {
					if(data.length != 0) {
						for (var i = 0; i < data.length; i++) {
							$(".g-search-category-hot").append(`<div class='g-search-category-block g-search-category-block-hot'>${data[i]}</div>`)
						}
						// 新增元素进行事件委托添加点击事件
						$('.g-search-category-block').on('click',function () {
							let val = $(this).html();
							$('.g-search-body-input').val(val)
						})
					}else{
						$(".g-search-category-hot").append(`<qwe style="display:block;text-indent: 2rem">暂无热词数据哦 >_< </qwe>`)
					}
			},
			error:function(){
			$(".g-search-category-hot").append(`<a style='color=red;font-weight:600'>抱歉，热词索引失败!请刷新重试</a>`)
			}
		});

		// 初始按钮事件绑定
		$('.g-search-category-block g-search-category-block-hot,.g-search-category-block g-search-category-block-history').on('click',function () {
			let val = $(this).html()
			$('.g-search-body-input').val(val)
		})

		// 搜索历史记录展示
		let $historyList = $('.g-search-category-history-list')
		let localStorageInitLength = localStorage.length
		if(localStorageInitLength <= 10){
			for(let i=localStorageInitLength;i>0;i--){
				$historyList.append(`<div class='g-search-category-block g-search-category-block-history'>${localStorage.getItem(i)}</div>`)
			}
		}else{
			for(let i=localStorageInitLength;i>localStorageInitLength - 10;i--){
				$historyList.append(`<div class='g-search-category-block g-search-category-block-history'>${localStorage.getItem(i)}</div>`)
			}
		}
		// localStorage本地记录历史清除
		$('#j-search-category-history-clear').on('click',function () {
			localStorage.clear();													// 清除本地存储
			$('.g-search-category-history-list').empty()							// 清除html内容
			$historyList.append(`<h4 style="color:#ff4843">删除成功!</h4>`)			// 显示提示信息
			setTimeout(function () {										// 3s后进行最终清除
				$('.g-search-category-history-list').empty()
			},3000)
		})

		// 搜索按钮点击后
		$('.g-search-body-sub').click(function (e){
			e.preventDefault();

			// 进行数据库索引
			let searchKeyword = $(this).prev().val();
			if(searchKeyword == ''){
				alert('请输入关键字!')
			}else {
				// 本地操作
				// 判断最近搜索只有10条
				let nodeLength = $('.g-search-category-block-history').length
				if(nodeLength >= 10){
					$('.g-search-category-block-history:last').remove()
				}
				// 搜索一条加一条最近搜索
				$('.g-search-category-history-list').prepend(`<div class='g-search-category-block g-search-category-block-history'>${searchKeyword}</div>`)
				// 新增元素进行事件委托添加点击事件
				$('.g-search-category-block').on('click', function () {
					let val = $(this).html();
					$('.g-search-body-input').val(val)
				})
				// localStorage本地历史记录
				let nowHistoryLength = localStorage.length
				localStorage.setItem((nowHistoryLength) + 1, searchKeyword);

				// 网络操作
				$resultList = $('.g-search-subResulte-list');
				$resultList.html(`【 ${searchKeyword} 】 搜索中，请稍后...`)
				$('.g-search-body-subResulte').show();
				$.ajax({
					type: "POST",
					url: "/siteSearch/",
					headers: {
						"X-CSRFToken": $.cookie('csrftoken')
					},
					data: {
						'keyword': searchKeyword,
					},
					success: function (data) {
						$resultList.empty();

						if (data.length != 0) {
							for (var i = 0; i < data.length; i++) {
								if (data[i].filter == 'title') {     // 优先显示符合关键字的标题
									$resultList.append(`<li><a href="/detail/${data[i]['id']} target='_blank'">${data[i]['title']}</a></li>`);
								} else {                              // 点击显示符合关键字的内容
									$resultList.append(`<li id="j-search-content-more" style="display: none"><a href="/detail/${data[i]['id']}" target='_blank'>${data[i]['title']}</a></li>`);
								}
							}
							// 点击显示更多按钮
							$resultList.append(`
								<div style="width: 100%;text-align: center">
									<span 
										style="cursor: pointer;font-size: 10px;padding: 5px 10px;border: 1px solid black;border-radius: 5px;display: inline-block;"
										onclick="$('#j-search-content-more').show();$(this).hide()"   
									 >查看全部相关结果</span>
								</div>
							`)
						} else {
							$resultList.append(`<qwe style="display:block;text-indent: 2rem">抱歉,暂时没有关于【 ${searchKeyword} 】的数据哦 >_< </qwe>`)
						}
					},
					error: function () {
						$resultList.empty();
						$resultList.append(`<a style='color=red;font-weight:600'>抱歉，搜索失败!请重试</a>`)
					}
				});
			}
		});
	}

	// ****************************** 以下为各项功能调用 ***************************

	resizeFun()							// 初始定位判断显示内容
	mouseFun()							// 鼠标点击集合
	goTop()							    // 回顶事件
	slidingFun()						// 页面size改变和滚动
	oauth()							    // 权限
	formConfirmReSet()					// 前端表单验证(重置密码)
	formConfirmSignUp()					// 前端表单验证(注册)
	searchHistory()						// 搜索历史记录

	// 上划显示导航栏，下滑消失(需要全局变量，暂时提出来写了)
	var p=0,t=0;
	$(window).scroll(function(){
		if($(this).width() > 900){
			p = $(this).scrollTop();

			if(t<=p){
				$('.g-top-navigation').css('opacity','0');
			}else{
				let $navigation = $(".g-top-navigation")

				$navigation.css('opacity','1');

				// 当置顶后导航栏回复透明底白字
				if(p > 100){
					$navigation.css('opacity','1');
					$navigation.addClass('g-top-navigation-show')
					$navigation.find('a').css('color','black')
					$navigation.find('#j-top-navigation-fun-search').css('border','0.1em solid black')
					$navigation.find('#j-top-navigation-fun-search').append(`<style>#j-top-navigation-fun-search:before{background:black!important}</style>`)
				}else{
					$navigation.removeClass('g-top-navigation-show')
					$navigation.find('a').css('color','white')
					$navigation.find('#j-top-navigation-fun-search').css('border','0.1em solid white')
					$navigation.find('#j-top-navigation-fun-search').append(`<style>#j-top-navigation-fun-search:before{background:white!important}</style>`)
				}
			}
			t = p;
		}
	})
}())